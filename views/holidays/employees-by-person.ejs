<%- layout('layouts/main') %>

<div class="max-w-full mx-auto px-4 py-5 sm:px-6">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-8 gap-4">
    <div>
      <h1 class="text-2xl font-bold text-gray-900 tracking-tight flex items-center gap-3">
        <div class="p-2 bg-cyan-50 rounded-lg text-cyan-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
        </div>
        Urlopy pracowników
      </h1>
      <p class="text-gray-500 mt-1 text-sm ml-[52px]">Przegląd urlopów i pracy zdalnej pracowników.</p>
    </div>

    <!-- Month Navigation -->
    <div class="flex items-center bg-gray-50 p-1 rounded-lg border border-gray-200 shadow-sm" id="monthNavigation"
         data-current-month="<%= month %>" data-current-year="<%= year %>">
      <button id="navigatePrevMonth" class="p-1.5 rounded-md hover:bg-white hover:shadow-sm text-gray-500 transition-all">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
      </button>
      <div class="flex items-center px-2 gap-1">
        <a href="#" id="prevMonthBtn" class="hidden md:block px-2 py-1 text-xs font-medium text-gray-400 hover:text-gray-600 transition-colors"></a>
        <span id="currentMonthBtn" class="px-3 py-1 text-sm font-bold text-gray-900"></span>
        <a href="#" id="nextMonthBtn" class="hidden md:block px-2 py-1 text-xs font-medium text-gray-400 hover:text-gray-600 transition-colors"></a>
      </div>
      <button id="navigateNextMonth" class="p-1.5 rounded-md hover:bg-white hover:shadow-sm text-gray-500 transition-all">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
      </button>
    </div>
  </div>

  <!-- View toggle and navigation tabs -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8">
    <div class="inline-flex items-center bg-gray-50 p-1 rounded-lg border border-gray-200 shadow-sm">
      <a href="/holidays" class="px-4 py-2 rounded-md text-sm font-medium text-gray-500 hover:text-gray-900 transition-all">
        Bieżący miesiąc
      </a>
      <a href="/holidays/future" class="px-4 py-2 rounded-md text-sm font-medium text-gray-500 hover:text-gray-900 transition-all">
        Przyszłe urlopy
      </a>
      <a href="/holidays/history" class="px-4 py-2 rounded-md text-sm font-medium text-gray-500 hover:text-gray-900 transition-all">
        Historia urlopów
      </a>
    </div>

    <!-- View mode toggle -->
    <div class="inline-flex items-center bg-gray-50 p-1 rounded-lg border border-gray-200 shadow-sm">
      <a href="/holidays/employees/by-person?month=<%= month %>&year=<%= year %>"
         class="px-4 py-2 rounded-md text-sm font-medium <%= currentView === 'by-person' ? 'bg-white shadow-sm text-blue-700 font-bold' : 'text-gray-500 hover:text-gray-900' %> transition-all">
        Wg osoby
      </a>
      <a href="/holidays/employees/by-date?month=<%= month %>&year=<%= year %>"
         class="px-4 py-2 rounded-md text-sm font-medium <%= currentView === 'by-date' ? 'bg-white shadow-sm text-blue-700 font-bold' : 'text-gray-500 hover:text-gray-900' %> transition-all">
        Wg daty
      </a>
    </div>
  </div>

  <!-- Legend -->
  <div class="mb-6 bg-white p-5 rounded-xl shadow-sm border border-gray-100">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-3">
      <h3 class="text-lg font-bold text-gray-800 flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        Legenda:
      </h3>
      <div class="mt-2 md:mt-0 flex items-center space-x-4">
        <div class="text-sm font-medium bg-red-50 rounded-lg px-3 py-1.5 border border-red-100 flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
          <span class="font-bold text-red-600"><%= totalEmployeesWithHolidays %></span>
        </div>
        <div class="text-sm font-medium bg-cyan-50 rounded-lg px-3 py-1.5 border border-cyan-100 flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-cyan-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
          <span class="font-bold text-cyan-600"><%= totalEmployeesWithRemoteWork %></span>
        </div>
      </div>
    </div>
    <div class="flex flex-wrap gap-4 justify-start">
      <div class="flex items-center p-2 rounded">
        <div class="w-6 h-6 bg-green-100 mr-2 rounded border border-green-200"></div>
        <span class="text-sm font-medium text-gray-700">Dzień pracujący</span>
      </div>
      <div class="flex items-center p-2 rounded">
        <div class="w-6 h-6 bg-cyan-100 mr-2 rounded border border-cyan-200 flex items-center justify-center">
          <span class="text-xs font-bold text-cyan-600">z</span>
        </div>
        <span class="text-sm font-medium text-gray-700">Praca zdalnie</span>
      </div>
      <div class="flex items-center p-2 rounded">
        <div class="w-6 h-6 bg-red-100 mr-2 rounded border border-red-200 flex items-center justify-center">
          <span class="text-xs font-bold text-red-300">u</span>
        </div>
        <span class="text-sm font-medium text-gray-700">Urlop</span>
      </div>
      <div class="flex items-center p-2 rounded">
        <div class="w-6 h-6 bg-purple-100 mr-2 rounded border border-purple-200"></div>
        <span class="text-sm font-medium text-gray-700">Święto</span>
      </div>
      <div class="flex items-center p-2 rounded">
        <div class="w-6 h-6 bg-gray-100 mr-2 rounded border border-gray-200"></div>
        <span class="text-sm font-medium text-gray-700">Weekend</span>
      </div>
    </div>
  </div>

  <!-- Search bar and filters -->
  <div class="mb-6 bg-white p-5 rounded-xl shadow-sm border border-gray-100">
    <div class="mb-4 flex items-center justify-between">
      <div class="flex items-center space-x-2">
        <span class="text-sm font-medium text-gray-700">Filtruj:</span>
        <button id="filterAll" class="px-3 py-1.5 text-sm rounded-md bg-blue-500 text-white font-medium" data-filter="all">
          Wszystkie
        </button>
        <button id="filterHolidays" class="px-3 py-1.5 text-sm rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300 font-medium" data-filter="holidays">
          <span class="text-xs font-bold text-red-300 mr-1">u</span>
          Urlopy
        </button>
        <button id="filterRemote" class="px-3 py-1.5 text-sm rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300 font-medium" data-filter="remote">
          <span class="text-xs font-bold text-cyan-600 mr-1">z</span>
          Zdalne
        </button>
      </div>
    </div>
    <div class="relative">
      <input
        type="text"
        id="employeeSearch"
        placeholder="Szukaj pracownika..."
        class="w-full px-4 py-3 pl-10 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm shadow-sm bg-gray-50 hover:bg-white transition-colors" />
      <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
        <svg class="h-5 w-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
        </svg>
      </div>
    </div>
  </div>

  <!-- Holiday Table -->
  <div class="overflow-x-auto">
    <div class="align-middle inline-block min-w-full">
      <% if (!groupedEmployees || groupedEmployees.length === 0) { %>
      <div class="text-center py-12 bg-gray-50 rounded-lg">
        <p class="text-gray-500 text-lg">
          Brak danych o urlopach lub pracy zdalnej pracowników w tym miesiącu.
        </p>
      </div>
      <% } else { %>
      <% groupedEmployees.forEach((group, groupIndex) => { %>
        <!-- Each group in its own card -->
        <div class="mb-6 shadow border-b border-gray-200 sm:rounded-lg group-container" data-group-id="<%= group.id %>">
          <!-- Group header -->
          <div class="bg-gray-100 border-b border-gray-300 px-6 py-3 text-left text-sm font-medium">
            <div class="flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
              </svg>
              <span class="text-base font-semibold text-gray-900"><%= group.name %></span>
              <span class="ml-2 bg-gray-200 text-gray-700 rounded-full px-2 py-1 text-xs">
                <%= group.employees.length %> <%= group.employees.length === 1 ? 'pracownik' : 'pracowników' %>
              </span>
            </div>
          </div>

          <!-- Group table -->
          <table class="min-w-full divide-y divide-gray-200">
            <colgroup>
              <col
                style="
                  width: 180px !important;
                  min-width: 180px !important;
                  max-width: 180px !important;
                " />
              <% for (let i = 0; i < daysInMonth.length; i++) { %>
              <col
                style="
                  width: 32px !important;
                  min-width: 32px !important;
                  max-width: 32px !important;
                " />
              <% } %>
              <col
                style="
                  width: 90px !important;
                  min-width: 90px !important;
                  max-width: 90px !important;
                " />
              <col
                style="
                  width: 90px !important;
                  min-width: 90px !important;
                  max-width: 90px !important;
                " />
            </colgroup>
            <thead class="bg-gray-50">
              <tr>
                <th
                  scope="col"
                  class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-50 z-10"
                  style="
                    width: 180px !important;
                    min-width: 180px !important;
                    max-width: 180px !important;
                  ">
                  Pracownik
                </th>

                <!-- Day headers -->
                <% daysInMonth.forEach(date => {
                  const dayDate = new Date(date);
                  const dayOfWeek = dayDate.getDay();
                  const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                  const dateKey = date.split('T')[0];
                  const isPublicHoliday = publicHolidays[dateKey];
                  let headerClass = "px-1 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider";
                  if (isWeekend) {
                    headerClass += " bg-gray-100";
                  } else if (isPublicHoliday) {
                    headerClass += " bg-purple-100";
                  }
                  let headerTitle = isPublicHoliday ? isPublicHoliday : '';
                %>
                <th
                  scope="col"
                  class="<%= headerClass %>"
                  title="<%= headerTitle %>"
                  style="
                    width: 32px !important;
                    min-width: 32px !important;
                    max-width: 32px !important;
                    height: 32px !important;
                  ">
                  <%= dayDate.getDate() %>
                </th>
                <% }); %>

                <th
                  scope="col"
                  class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider sticky bg-gray-50 z-10"
                  style="
                    width: 90px !important;
                    min-width: 90px !important;
                    max-width: 90px !important;
                    right: 90px;
                  ">
                  Urlopy
                </th>
                <th
                  scope="col"
                  class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider sticky right-0 bg-gray-50 z-10"
                  style="
                    width: 90px !important;
                    min-width: 90px !important;
                    max-width: 90px !important;
                  ">
                  Zdalne
                </th>
              </tr>
            </thead>

            <tbody class="bg-white divide-y divide-gray-200">
              <% if (group.employees.length === 0) { %>
              <tr>
                <td colspan="<%= daysInMonth.length + 3 %>" class="px-2 py-3 text-center text-sm text-gray-500">
                  Brak pracowników z urlopami lub pracą zdalną w tej grupie
                </td>
              </tr>
              <% } else { %>
                <% group.employees.forEach((employee, employeeIndex) => { %>
                <tr
                  class="employee-row <%= employeeIndex % 2 === 0 ? 'bg-white' : 'bg-gray-50' %>"
                  data-name="<%= employee.name.toLowerCase() %>"
                  data-email="<%= employee.email.toLowerCase() %>"
                  data-group-id="<%= group.id %>"
                  data-has-holidays="<%= employee.holidayCount > 0 ? 'true' : 'false' %>"
                  data-has-remote="<%= employee.remoteDaysCount > 0 ? 'true' : 'false' %>">
                  <!-- Employee name (sticky) -->
                  <td
                    class="px-2 py-2 whitespace-nowrap truncate text-sm font-medium text-gray-900 sticky left-0 <%= employeeIndex % 2 === 0 ? 'bg-white' : 'bg-gray-50' %> z-10"
                    style="
                      width: 180px !important;
                      min-width: 180px !important;
                      max-width: 180px !important;
                    "
                    title="<%= employee.name %>">
                    <%= employee.name %>
                  </td>

                  <!-- Holiday status for each day -->
                  <%
                    daysInMonth.forEach(date => {
                      const isHoliday = employee.holidays.includes(date);
                      const dayDate = new Date(date);
                      const dayOfWeek = dayDate.getDay();
                      const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                      const dateKey = date.split('T')[0];
                      const isPublicHoliday = publicHolidays[dateKey];
                      const workLocation = employee.workLocations ? employee.workLocations[dateKey] : undefined;
                      const isRemote = workLocation === false; // is_onsite === false means remote

                      let cellClass = "";
                      let tooltip = '';
                      let showIndicator = null;

                      if (isHoliday) {
                        cellClass += " bg-red-100";
                        tooltip = 'Urlop';
                        showIndicator = 'u';
                      } else if (isWeekend) {
                        cellClass += " bg-gray-100";
                      } else if (isPublicHoliday) {
                        cellClass += " bg-purple-100";
                        tooltip = `Święto: ${isPublicHoliday}`;
                      } else if (isRemote) {
                        cellClass += " bg-cyan-100";
                        tooltip = 'Praca zdalnie';
                        showIndicator = 'z';
                      } else {
                        cellClass += " bg-green-100";
                      }
                  %>
                  <td
                    class="<%= cellClass.trim() %>"
                    title="<%= tooltip %>"
                    style="
                      width: 32px !important;
                      min-width: 32px !important;
                      max-width: 32px !important;
                      height: 32px !important;
                      padding: 0;
                      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.04), 0 1px 2px 0 rgba(0, 0, 0, 0.02);
                    ">
                    <% if (showIndicator === 'u') { %>
                    <div class="w-full h-full flex items-center justify-center text-xs font-bold text-red-300">u</div>
                    <% } else if (showIndicator === 'z') { %>
                    <div class="w-full h-full flex items-center justify-center text-xs font-bold text-cyan-600">z</div>
                    <% } %>
                  </td>
                  <% }); %>

                  <!-- Holiday count (sticky) -->
                  <td
                    class="px-2 py-2 whitespace-nowrap text-sm font-medium text-gray-900 text-center sticky <%= employeeIndex % 2 === 0 ? 'bg-white' : 'bg-gray-50' %> z-10"
                    style="
                      width: 90px !important;
                      min-width: 90px !important;
                      max-width: 90px !important;
                      right: 90px;
                    ">
                    <%= employee.holidayCount %>
                  </td>

                  <!-- Remote days count (sticky) -->
                  <td
                    class="px-2 py-2 whitespace-nowrap text-sm font-medium text-gray-900 text-center sticky right-0 <%= employeeIndex % 2 === 0 ? 'bg-white' : 'bg-gray-50' %> z-10"
                    style="
                      width: 90px !important;
                      min-width: 90px !important;
                      max-width: 90px !important;
                    ">
                    <%= employee.remoteDaysCount %>
                  </td>
                </tr>
                <% }); %>
              <% } %>
            </tbody>
          </table>
        </div>
      <% }); %>
      <% } %>
    </div>
  </div>
</div>

<script>
  // Month navigation state
  const selectedMonth = parseInt(document.getElementById('monthNavigation').dataset.currentMonth);
  const selectedYear = parseInt(document.getElementById('monthNavigation').dataset.currentYear);
  let displayMonth = selectedMonth;
  let displayYear = selectedYear;

  function getMonthName(month, year) {
    return new Date(year, month - 1, 1).toLocaleString('pl-PL', { month: 'long' });
  }

  function getShortMonthName(month, year) {
    return new Date(year, month - 1, 1).toLocaleString('pl-PL', { month: 'short' });
  }

  function updateMonthDisplay() {
    const prevMonth = displayMonth === 1 ? 12 : displayMonth - 1;
    const prevYear = displayMonth === 1 ? displayYear - 1 : displayYear;
    const nextMonth = displayMonth === 12 ? 1 : displayMonth + 1;
    const nextYear = displayMonth === 12 ? displayYear + 1 : displayYear;

    // Update button texts
    document.getElementById('prevMonthBtn').textContent = getShortMonthName(prevMonth, prevYear);

    // Capitalize first letter of current month
    const currentMonthName = getMonthName(displayMonth, displayYear);
    const capitalizedMonth = currentMonthName.charAt(0).toUpperCase() + currentMonthName.slice(1);
    document.getElementById('currentMonthBtn').textContent = capitalizedMonth + ' ' + displayYear;

    document.getElementById('nextMonthBtn').textContent = getShortMonthName(nextMonth, nextYear);

    // Update button links
    document.getElementById('prevMonthBtn').href = `/holidays/employees/by-person?month=${prevMonth}&year=${prevYear}`;
    document.getElementById('nextMonthBtn').href = `/holidays/employees/by-person?month=${nextMonth}&year=${nextYear}`;
  }

  function navigateMonth(direction) {
    if (direction === -1) {
      if (displayMonth === 1) {
        displayMonth = 12;
        displayYear--;
      } else {
        displayMonth--;
      }
    } else {
      if (displayMonth === 12) {
        displayMonth = 1;
        displayYear++;
      } else {
        displayMonth++;
      }
    }
    // Navigate
    window.location.href = `/holidays/employees/by-person?month=${displayMonth}&year=${displayYear}`;
  }

  document.addEventListener("DOMContentLoaded", function () {
    // Initialize month display
    updateMonthDisplay();

    // Month navigation buttons
    const navigatePrevBtn = document.getElementById('navigatePrevMonth');
    const navigateNextBtn = document.getElementById('navigateNextMonth');

    if (navigatePrevBtn) {
      navigatePrevBtn.addEventListener('click', function() {
        navigateMonth(-1);
      });
    }

    if (navigateNextBtn) {
      navigateNextBtn.addEventListener('click', function() {
        navigateMonth(1);
      });
    }

    const searchInput = document.getElementById("employeeSearch");
    const employeeRows = document.querySelectorAll(".employee-row");
    const groupContainers = document.querySelectorAll(".group-container");
    const filterButtons = document.querySelectorAll('[data-filter]');
    let activeFilter = 'all'; // Default filter

    function updateVisibility() {
      const searchTerm = searchInput.value.toLowerCase().trim();

      // First, filter employee rows
      employeeRows.forEach((row) => {
        const name = row.dataset.name;
        const email = row.dataset.email;
        const hasHolidays = row.dataset.hasHolidays === 'true';
        const hasRemote = row.dataset.hasRemote === 'true';

        // Check search term match
        const matchesSearch = name.includes(searchTerm) || email.includes(searchTerm);

        // Check filter match
        let matchesFilter = true;
        if (activeFilter === 'holidays') {
          matchesFilter = hasHolidays;
        } else if (activeFilter === 'remote') {
          matchesFilter = hasRemote;
        }
        // 'all' filter always matches

        if (matchesSearch && matchesFilter) {
          row.style.display = "";
        } else {
          row.style.display = "none";
        }
      });

      // Then, hide/show groups based on visible employees
      groupContainers.forEach((groupContainer) => {
        const groupId = groupContainer.dataset.groupId;
        const groupEmployeeRows = document.querySelectorAll(`.employee-row[data-group-id="${groupId}"]`);

        // Check if any employee in this group is visible
        const hasVisibleEmployees = Array.from(groupEmployeeRows).some(row =>
          row.style.display !== "none"
        );

        if (hasVisibleEmployees) {
          groupContainer.style.display = "";
        } else {
          groupContainer.style.display = "none";
        }
      });
    }

    // Filter button click handlers
    filterButtons.forEach(button => {
      button.addEventListener('click', function() {
        // Update active filter
        activeFilter = this.dataset.filter;

        // Update button styles
        filterButtons.forEach(btn => {
          if (btn.dataset.filter === activeFilter) {
            btn.className = 'px-3 py-1.5 text-sm rounded-md bg-blue-500 text-white font-medium';
          } else {
            btn.className = 'px-3 py-1.5 text-sm rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300 font-medium';
          }
        });

        // Update visibility
        updateVisibility();
      });
    });

    searchInput.addEventListener("input", updateVisibility);

    // Clear search when clicking the X button (for browsers that support it)
    searchInput.addEventListener("search", function () {
      if (this.value === "") {
        updateVisibility();
      }
    });
  });
</script>
